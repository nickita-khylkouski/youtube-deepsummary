{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div style="margin-bottom: 25px;">
    <div class="breadcrumb-nav" style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <a href="/blog" style="color: #555; text-decoration: none; font-size: 15px; font-weight: 500; padding: 8px 12px; border-radius: 6px; background: #f5f5f5; transition: all 0.2s ease;">‚Üê All Blog Posts</a>
        <span style="color: #ccc; font-size: 16px;">‚Ä¢</span>
        <a href="/{{ channel_info.handle }}" style="color: #555; text-decoration: none; font-size: 15px; font-weight: 500; padding: 8px 12px; border-radius: 6px; background: #f5f5f5; transition: all 0.2s ease;">{{ channel_info.channel_name }}</a>
    </div>
</div>

<div class="channel-blog-header" style="display: flex; align-items: center; gap: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #e5e5e5;">
    {% if channel_info and channel_info.thumbnail_url %}
        <img src="{{ channel_info.thumbnail_url }}" 
             alt="{{ channel_info.channel_name }} thumbnail" 
             style="width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    {% else %}
        <div style="width: 90px; height: 90px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 36px; flex-shrink: 0; border: 4px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            {{ channel_info.channel_name[0]|upper if channel_info.channel_name else 'üì∫' }}
        </div>
    {% endif %}
    <div style="flex: 1; min-width: 0;">
        <h1 style="margin: 0 0 12px 0; font-size: 28px; color: #1a1a1a; font-weight: 600;">üìù {{ channel_info.channel_name }} Blog</h1>
        <p style="margin: 0; color: #555; font-size: 18px; font-weight: 500;">{{ total_count }} AI blog posts</p>
        {% if channel_info and channel_info.handle %}
            <p style="margin: 8px 0 0 0; color: #777; font-size: 16px;">{{ channel_info.handle }}</p>
        {% endif %}
    </div>
</div>

<div class="blog-container" style="max-width: 900px; margin: 0 auto;">
    {% if initial_posts %}
        <div class="infinite-reading" id="blog-reading">
            <!-- Initial posts loaded from server -->
            {% for post in initial_posts %}
                {% include 'blog/blog_reading_card.html' %}
            {% endfor %}
        </div>
        
        <!-- Loading indicator -->
        <div id="loading-indicator" style="text-align: center; padding: 40px; display: none;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #6c757d;">Loading more posts...</p>
        </div>
        
        <!-- End of content indicator -->
        <div id="end-indicator" style="text-align: center; padding: 40px; color: #6c757d; display: none;">
            <p style="margin: 0; font-size: 16px;">üéâ You've seen all blog posts from {{ channel_info.channel_name }}!</p>
        </div>
    {% else %}
        <div class="no-posts" style="text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef;">
            <div style="font-size: 48px; margin-bottom: 20px;">üìù</div>
            <h3 style="margin: 0 0 15px 0; color: #495057;">No Blog Posts Yet</h3>
            <p style="margin: 0; color: #6c757d; font-size: 16px;">This channel doesn't have any AI summaries available for blog posts yet.</p>
            <p style="margin: 15px 0 0 0;">
                <a href="/{{ channel_info.handle }}" style="color: #667eea; text-decoration: none; font-weight: 500;">
                    Visit channel page ‚Üí
                </a>
            </p>
        </div>
    {% endif %}
</div>

<style>
    /* Breadcrumb navigation styles */
    .breadcrumb-nav a:hover {
        background: #e3f2fd !important;
        color: #1565c0 !important;
        transform: translateY(-1px);
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .reading-post {
        background: white;
        border-radius: 12px;
        padding: 40px;
        margin-bottom: 40px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .post-header {
        border-bottom: 2px solid #f1f3f4;
        padding-bottom: 25px;
        margin-bottom: 30px;
    }
    
    .post-content {
        line-height: 1.8;
        font-size: 16px;
        color: #333;
    }
    
    @media (max-width: 768px) {
        .blog-container {
            max-width: 100% !important;
            padding: 0 15px !important;
        }
        
        .reading-post {
            padding: 25px !important;
            margin-bottom: 25px !important;
        }
        
        .channel-blog-header {
            flex-direction: column !important;
            text-align: center !important;
            gap: 15px !important;
        }
        
        .channel-blog-header h1 {
            font-size: 24px !important;
        }
    }
</style>

<script>
let currentOffset = {{ initial_posts|length }};
let isLoading = false;
let hasMorePosts = {{ 'true' if initial_posts|length >= 12 else 'false' }};
const channelHandle = '{{ channel_info.handle }}';

// Load more posts
async function loadMorePosts() {
    if (isLoading || !hasMorePosts) return;
    
    isLoading = true;
    document.getElementById('loading-indicator').style.display = 'block';
    
    try {
        const response = await fetch(`/blog/api/posts/${channelHandle}?offset=${currentOffset}&limit=12`);
        const data = await response.json();
        
        if (data.success && data.posts.length > 0) {
            
            data.posts.forEach(post => {
                const article = createReadingPost(post);
                document.getElementById('blog-reading').appendChild(article);
            });
            
            currentOffset += data.posts.length;
            hasMorePosts = data.has_more;
        } else {
            hasMorePosts = false;
        }
        
        if (!hasMorePosts) {
            document.getElementById('end-indicator').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading more posts:', error);
        hasMorePosts = false;
    } finally {
        isLoading = false;
        document.getElementById('loading-indicator').style.display = 'none';
    }
}

// Create reading post HTML
function createReadingPost(post) {
    const article = document.createElement('article');
    article.className = 'reading-post';
    
    const publishDate = new Date(post.published_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    // Use pre-converted HTML or convert basic formatting
    const summaryHtml = post.summary_html || post.summary_text
        .replace(/#{1,6}\s*(.*)/g, '<h3 style="margin: 25px 0 15px 0; font-size: 20px; font-weight: 600; color: #1a1a1a;">$1</h3>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^[‚Ä¢\-\*]\s*(.*)$/gm, '<li style="margin-bottom: 8px;">$1</li>')
        .replace(/((?:<li[^>]*>.*<\/li>\s*)+)/gs, '<ul style="margin: 15px 0; padding-left: 25px;">$1</ul>')
        .replace(/\n\n/g, '</p><p style="margin: 15px 0; line-height: 1.8;">')
        .replace(/^/, '<p style="margin: 15px 0; line-height: 1.8;">')
        .replace(/$/, '</p>');
    
    article.innerHTML = `
        <header class="post-header">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                ${post.channel_thumbnail ? `<img src="${post.channel_thumbnail}" alt="${post.channel_name}" 
                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : ''}
                <div>
                    <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #667eea;">${post.channel_name}</h4>
                    <p style="margin: 2px 0 0 0; font-size: 14px; color: #6c757d;">${publishDate}</p>
                </div>
            </div>
            <h2 style="margin: 0 0 15px 0; font-size: 28px; font-weight: 700; color: #1a1a1a; line-height: 1.3;">
                ${post.title}
            </h2>
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <a href="https://youtube.com/watch?v=${post.video_id}" target="_blank" 
                   style="color: #ff0000; text-decoration: none; font-weight: 500; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                    üé• Watch on YouTube
                </a>
                <span style="color: #6c757d; font-size: 14px;">‚Ä¢</span>
                <span style="color: #6c757d; font-size: 14px;">AI Summary by ${post.model_used || 'GPT-4'}</span>
            </div>
        </header>
        
        <div class="post-content">
            ${summaryHtml}
        </div>
    `;
    
    return article;
}

// Infinite scroll
function handleScroll() {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
        loadMorePosts();
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    if (hasMorePosts) {
        window.addEventListener('scroll', handleScroll);
    }
});
</script>
{% endblock %}