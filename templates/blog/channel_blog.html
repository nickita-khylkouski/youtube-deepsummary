{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div style="margin-bottom: 25px;">
    <div class="breadcrumb-nav" style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <a href="/blog" style="color: #555; text-decoration: none; font-size: 15px; font-weight: 500; padding: 8px 12px; border-radius: 6px; background: #f5f5f5; transition: all 0.2s ease;">‚Üê All Blog Posts</a>
        <span style="color: #ccc; font-size: 16px;">‚Ä¢</span>
        <a href="/{{ channel_info.handle }}" style="color: #555; text-decoration: none; font-size: 15px; font-weight: 500; padding: 8px 12px; border-radius: 6px; background: #f5f5f5; transition: all 0.2s ease;">{{ channel_info.channel_name }}</a>
    </div>
</div>

<div class="channel-blog-header" style="display: flex; align-items: center; gap: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #e5e5e5;">
    {% if channel_info and channel_info.thumbnail_url %}
        <img src="{{ channel_info.thumbnail_url }}" 
             alt="{{ channel_info.channel_name }} thumbnail" 
             style="width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    {% else %}
        <div style="width: 90px; height: 90px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 36px; flex-shrink: 0; border: 4px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            {{ channel_info.channel_name[0]|upper if channel_info.channel_name else 'üì∫' }}
        </div>
    {% endif %}
    <div style="flex: 1; min-width: 0;">
        <h1 style="margin: 0 0 12px 0; font-size: 28px; color: #1a1a1a; font-weight: 600;">üìù {{ channel_info.channel_name }} Blog</h1>
        <p style="margin: 0; color: #555; font-size: 18px; font-weight: 500;">{{ total_count }} AI blog posts</p>
        {% if channel_info and channel_info.handle %}
            <p style="margin: 8px 0 0 0; color: #777; font-size: 16px;">{{ channel_info.handle }}</p>
        {% endif %}
    </div>
</div>

<div class="blog-container" style="max-width: 1200px; margin: 0 auto;">
    {% if initial_posts %}
        <div class="blog-grid" id="blog-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-bottom: 40px;">
            <!-- Initial posts loaded from server -->
            {% for post in initial_posts %}
                {% include 'blog/blog_card.html' %}
            {% endfor %}
        </div>
        
        <!-- Loading indicator -->
        <div id="loading-indicator" style="text-align: center; padding: 40px; display: none;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #6c757d;">Loading more posts...</p>
        </div>
        
        <!-- End of content indicator -->
        <div id="end-indicator" style="text-align: center; padding: 40px; color: #6c757d; display: none;">
            <p style="margin: 0; font-size: 16px;">üéâ You've seen all blog posts from {{ channel_info.channel_name }}!</p>
        </div>
    {% else %}
        <div class="no-posts" style="text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef;">
            <div style="font-size: 48px; margin-bottom: 20px;">üìù</div>
            <h3 style="margin: 0 0 15px 0; color: #495057;">No Blog Posts Yet</h3>
            <p style="margin: 0; color: #6c757d; font-size: 16px;">This channel doesn't have any AI summaries available for blog posts yet.</p>
            <p style="margin: 15px 0 0 0;">
                <a href="/{{ channel_info.handle }}" style="color: #667eea; text-decoration: none; font-weight: 500;">
                    Visit channel page ‚Üí
                </a>
            </p>
        </div>
    {% endif %}
</div>

<style>
    /* Breadcrumb navigation styles */
    .breadcrumb-nav a:hover {
        background: #e3f2fd !important;
        color: #1565c0 !important;
        transform: translateY(-1px);
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .blog-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid #e9ecef;
    }
    
    .blog-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    @media (max-width: 768px) {
        .blog-grid {
            grid-template-columns: 1fr !important;
            gap: 20px !important;
        }
        
        .channel-blog-header {
            flex-direction: column !important;
            text-align: center !important;
            gap: 15px !important;
        }
        
        .channel-blog-header h1 {
            font-size: 24px !important;
        }
    }
</style>

<script>
let currentOffset = {{ initial_posts|length }};
let isLoading = false;
let hasMorePosts = {{ 'true' if initial_posts|length >= 12 else 'false' }};
const channelHandle = '{{ channel_info.handle }}';

// Load more posts
async function loadMorePosts() {
    if (isLoading || !hasMorePosts) return;
    
    isLoading = true;
    document.getElementById('loading-indicator').style.display = 'block';
    
    try {
        const response = await fetch(`/blog/api/posts/${channelHandle}?offset=${currentOffset}&limit=12`);
        const data = await response.json();
        
        if (data.success && data.posts.length > 0) {
            const blogGrid = document.getElementById('blog-grid');
            
            data.posts.forEach(post => {
                const card = createBlogCard(post);
                blogGrid.appendChild(card);
            });
            
            currentOffset += data.posts.length;
            hasMorePosts = data.has_more;
        } else {
            hasMorePosts = false;
        }
        
        if (!hasMorePosts) {
            document.getElementById('end-indicator').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading more posts:', error);
        hasMorePosts = false;
    } finally {
        isLoading = false;
        document.getElementById('loading-indicator').style.display = 'none';
    }
}

// Create blog card HTML
function createBlogCard(post) {
    const card = document.createElement('div');
    card.className = 'blog-card';
    
    const blogUrl = `/blog/${post.channel_handle}/${post.url_path}`;
    const publishDate = new Date(post.published_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    card.innerHTML = `
        <div style="position: relative;">
            <img src="${post.thumbnail_url}" alt="${post.title}" 
                 style="width: 100%; height: 200px; object-fit: cover;">
            <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                ${post.duration}
            </div>
        </div>
        <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                <img src="${post.channel_thumbnail || '/static/default-avatar.png'}" alt="${post.channel_name}" 
                     style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
                <a href="/blog/${post.channel_handle}" style="color: #667eea; text-decoration: none; font-size: 14px; font-weight: 500;">
                    ${post.channel_name}
                </a>
                <span style="color: #6c757d; font-size: 12px;">‚Ä¢</span>
                <span style="color: #6c757d; font-size: 12px;">${publishDate}</span>
            </div>
            <h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600; line-height: 1.4;">
                <a href="${blogUrl}" style="color: #333; text-decoration: none;">${post.title}</a>
            </h3>
            <p style="margin: 0 0 15px 0; color: #6c757d; font-size: 14px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                ${post.summary_preview || 'AI-generated summary available...'}
            </p>
            <a href="${blogUrl}" style="color: #667eea; text-decoration: none; font-size: 14px; font-weight: 500;">
                Read full summary ‚Üí
            </a>
        </div>
    `;
    
    return card;
}

// Infinite scroll
function handleScroll() {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
        loadMorePosts();
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    if (hasMorePosts) {
        window.addEventListener('scroll', handleScroll);
    }
});
</script>
{% endblock %}